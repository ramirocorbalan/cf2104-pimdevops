#creacion de cluster eks
eksctl create cluster --name eks-mundos-e --region us-east-2 --node-type t2.micro --with-oidc --ssh-access --ssh-public-key devops-workstation --managed --full-ecr-access --zones us-east-2a,us-east-2b,us-east-2c


#usuario para atregar al kubectl
mapUsers:
	- userarn: arn:aws:iam::279445133194:user/ramiromundose
	  username: ramiromundose
	  groups:
		- system:masters



#para editar la configuracion de aws
eksctl get iamidentitymapping --cluster eks-mundos-e --region=us-east-2


eksctl create iamidentitymapping --cluster eks-mundos-e --region=us-east-2 --arn arn:aws:iam::279445133194:user/ramiromundose --group system:masters --no-duplicate-arns



#secret para azdo
ado-token-m7vb8



#para configurar mi secret para azdo
kubectl get secret ado-token-m7vb8 -n kube-system -o json


#json de la service account ado
{
    "apiVersion": "v1",
    "data": {
        "ca.crt": "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM1ekNDQWMrZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1EVXhOREUzTWpFeE9Gb1hEVE15TURVeE1URTNNakV4T0Zvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBS3QzCkNmcXhXZlQ5WlpkR1BKWTJvZmhpaUxTTjJXRWZzUDhKdVVsT2hHR2drUDhZMUVPR1pWNXNoU2JIMk4ySWZsajEKWlE5eTBWR01RTzBwTXQ1WUR2VDlsMkFhOHhVVDVNckMyaVk2Uk1nTHpHYitUeENFampYamtFdlBTek1XZ0lldgorY3BhQmUxY0xQdVVxbXpJWkppV3ZtRGZ1OFFUUHdnTjY2ME9wdUlrOHZzcVZZb3RTaFdaN2Vza2hjalhLZXNlCmZmNWxqRVUxV0xBZ2ordktQd0RobTVoVXU1WElEdXVqUkVKR2s3bkFtNXJCU202ODc0RHpNaEo0WVdsc29ONFMKdmNDRUVGR0l3MzRUckNudWdpUnpnTEpNS3R1SHl6ZHFyVkJDbC9jb2psbGo1NWk1VEI1L3dHbVVpOEYyZWF0ZQpCZFZ2VXkwSTFuVUF2aENjdU5jQ0F3RUFBYU5DTUVBd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZQR0xocEt2b3QxU1ZWZ2p4TTF2SmllejFwK1JNQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElCQVFCeGNYeVM1cmlwWFVKT2RFNEQxV0VGcWJSMFBlT2tvSUcyR3NKVDdweFhzSmpBc2p2VAp4bWJCVUdpR1JDYlh6OHJwMU5yNU8vQXhyRWZsYm1hYXd4d3BxWlFVTlFKaVpNRU51UFpuQytQeGtJdm1JY0NLCmdEWDV5TW41YnZKS0xMTGM4OHFHczQxb1NlYnUyc2RJcDN4elZ5SHpLeUNyKzRRdldVMW1LVjQ0SlErSk5WR0cKdTMxenJ3QVcvNGJLMXdTYUErbTR5MjhIMzMzVmowUDI3VGZ3LzFINnN6Wi9JWnhqK1ZFa0l3KzFYZG1VR2I2QQovUjZOVVVCYUtSa3BQZ2FZZWY0QlM2OXlJRmlwVksvaEk1KzQ1YkE4aCtpRjg2TlVoVFpDczNNd2hWdk1FR3RoCmkvNHBjeHgyN1l3VGZYYmE4ZFBpZFg1UnU3THIxNjV0enFFRQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==",
        "namespace": "a3ViZS1zeXN0ZW0=",
        "token": "ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNklsQm9WRUpEUlhaeldHNUtVMHBuV25SdllsWktSMjQxVTAweGNtbEZhV1ZrWlZZMU5GbFhNekZmTkRnaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUpyZFdKbExYTjVjM1JsYlNJc0ltdDFZbVZ5Ym1WMFpYTXVhVzh2YzJWeWRtbGpaV0ZqWTI5MWJuUXZjMlZqY21WMExtNWhiV1VpT2lKaFpHOHRkRzlyWlc0dGJUZDJZamdpTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWVdSdklpd2lhM1ZpWlhKdVpYUmxjeTVwYnk5elpYSjJhV05sWVdOamIzVnVkQzl6WlhKMmFXTmxMV0ZqWTI5MWJuUXVkV2xrSWpvaU9URmtZamRsT0dVdFlUbGxaUzAwTldVMUxXRmhZV010TldJMFkyVTRNMkl6WXpWaklpd2ljM1ZpSWpvaWMzbHpkR1Z0T25ObGNuWnBZMlZoWTJOdmRXNTBPbXQxWW1VdGMzbHpkR1Z0T21Ga2J5SjkuZ2xxNTlxQ2JFQ0NlbnFhclktbFNubWU5NVg4SmtkcnZBZzJFdDFjM29CWFFxTmpWQkZNaDByWUthc3QxZGk5NGRaZDlRNWFzeUV4RUpaUEEtMEF3NnZ3VEl0NmI0Z3duOHZJYm9ZaEZiYmNvZFFjbTUzX29JN3duMVY3YmtoX0d5eHNpWlJZbnZQWkZFeDhRV1l1bFpyYk50eUdjTkI0NWlaM2ZfQlViVHo1UlNicDFKSnpmYVNKQUsydWxTNGdhVjM3ZWlmMGoyS2NQUTZWeGFzdHRIQzN0MHI3WTZhamFLV3g3RHoxMmpJVFlxcU9sR1h0WDdTT1pIQl9QdU9rWFBpVmYyNldSeGltZF9JZ1JHT1M4Z1IyV2dDZUhuVTBTWkpDV0taaVJpTTFtSXkzd2xKVUx0cC1VZndKLTBLbzVJYTBlajhVUTF4eUZXRjdnTXlpbVZ3"
    },
    "kind": "Secret",
    "metadata": {
        "annotations": {
            "kubernetes.io/service-account.name": "ado",
            "kubernetes.io/service-account.uid": "91db7e8e-a9ee-45e5-aaac-5b4ce83b3c5c"
        },
        "creationTimestamp": "2022-05-14T18:45:06Z",
        "name": "ado-token-m7vb8",
        "namespace": "kube-system",
        "resourceVersion": "11923",
        "uid": "4ce8a4a7-cb4f-4aba-9867-586572a839bd"
    },
    "type": "kubernetes.io/service-account-token"
}



https://CF319DFEC53388E200988AEE34109830.gr7.us-east-2.eks.amazonaws.com



#deploy del contenedor nginx
http://a9c8a75593b18428a861050508f2812b-1628979674.us-east-2.elb.amazonaws.com



eksctl utils associate-iam-oidc-provider --cluster eks-mundos-e --approve

eksctl create iamserviceaccount --name fluent-bit --namespace logging --cluster eks-mundos-e --attach-policy-arn "arn:aws:iam::${ACCOUNT_ID}:policy/fluent-bit-policy" --approve --override-existing-serviceaccounts

curl -sS https://www.eksworkshop.com/intermediate/230_logging/deploy.files/es_domain.json | envsubst > ~/environment/logging/es_domain.json

aws es create-elasticsearch-domain --cli-input-json file://~/environment/logging/es_domain.json

#para crear el domain de elastic se tuvieron que cambiar algunas opciones del archivo es_domain.json

#para ver si termino de crearse el dominio
if [ $(aws es describe-elasticsearch-domain --domain-name ${ES_DOMAIN_NAME} --query 'DomainStatus.Processing') == "false" ]
then
tput setaf 2; echo "The Elasticsearch cluster is ready"
else
tput setaf 1;echo "The Elasticsearch cluster is NOT ready"
fi